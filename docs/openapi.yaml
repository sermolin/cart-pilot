openapi: 3.0.3
info:
  title: CartPilot API
  description: |
    Agent-first commerce orchestration backend for AI assistants to perform test purchases.
    
    CartPilot provides a stable, deterministic backend for AI assistants to:
    - Create purchase intents from natural language queries
    - Collect offers from multiple merchants
    - Manage checkout approval workflows
    - Track order lifecycle
    
    ## Workflow
    
    1. **Create Intent**: Convert user's purchase request into an intent
    2. **Get Offers**: Collect product offers from merchants for the intent
    3. **Create Checkout**: Start checkout process from an offer
    4. **Get Quote**: Get pricing from merchant
    5. **Request Approval**: Freeze receipt and request human approval
    6. **Approve**: Approve the purchase
    7. **Confirm**: Execute the purchase and create order
    8. **Track Order**: Monitor order status and lifecycle
    
    ## Authentication
    
    All requests require Bearer token authentication via the `Authorization` header.
  version: 0.1.0
  contact:
    name: CartPilot Support
    url: https://github.com/cartpilot

servers:
  - url: https://cartpilot-api-xxxx.run.app
    description: Production server (replace with actual URL)
  - url: http://localhost:8000
    description: Local development server

tags:
  - name: Intents
    description: Purchase intent management
  - name: Offers
    description: Merchant offer retrieval
  - name: Checkouts
    description: Checkout approval workflow
  - name: Orders
    description: Order lifecycle management
  - name: Health
    description: Health check endpoints

security:
  - bearerAuth: []

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Check if the API is healthy and ready to accept requests
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /intents:
    post:
      tags:
        - Intents
      summary: Create purchase intent
      description: |
        Create a new purchase intent from a natural language query.
        
        The intent captures the user's purchase intention. After creating an intent,
        use GET /intents/{intent_id}/offers to collect offers from merchants.
        
        Example queries:
        - "I need wireless headphones under $100"
        - "Find me a laptop for programming"
        - "Looking for running shoes size 10"
      operationId: createIntent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IntentCreateRequest'
            example:
              query: "wireless headphones under $100"
              session_id: "chat-session-123"
              metadata:
                max_price: 10000
                category: "electronics"
      responses:
        '201':
          description: Intent created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IntentResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /intents/{intent_id}:
    get:
      tags:
        - Intents
      summary: Get intent details
      description: Retrieve details about a specific purchase intent
      operationId: getIntent
      parameters:
        - name: intent_id
          in: path
          required: true
          schema:
            type: string
          description: Unique intent identifier
      responses:
        '200':
          description: Intent details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IntentResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Intent not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /intents/{intent_id}/offers:
    get:
      tags:
        - Offers
      summary: Get offers for intent
      description: |
        Get offers from merchants for this intent. 
        
        If offers haven't been collected yet, this endpoint will automatically
        trigger collection from all enabled merchants. Subsequent calls will return
        cached offers.
        
        Use pagination to retrieve all offers if there are many.
      operationId: getIntentOffers
      parameters:
        - name: intent_id
          in: path
          required: true
          schema:
            type: string
          description: Intent identifier
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number (1-based)
        - name: page_size
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Items per page
      responses:
        '200':
          description: List of offers
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OffersListResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Intent not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /offers/{offer_id}:
    get:
      tags:
        - Offers
      summary: Get offer details
      description: |
        Get detailed information about a specific offer including all product items,
        pricing, merchant details, and expiration information.
      operationId: getOffer
      parameters:
        - name: offer_id
          in: path
          required: true
          schema:
            type: string
          description: Offer identifier
      responses:
        '200':
          description: Offer details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OfferResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Offer not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /checkouts:
    post:
      tags:
        - Checkouts
      summary: Create checkout from offer
      description: |
        Create a new checkout session from an offer. 
        
        The checkout starts in 'created' state. Use the idempotency_key to safely
        retry requests without creating duplicate checkouts.
      operationId: createCheckout
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckoutCreateRequest'
            example:
              offer_id: "offer-123"
              items:
                - product_id: "prod-001"
                  variant_id: "var-001"
                  quantity: 1
              idempotency_key: "unique-key-123"
      responses:
        '201':
          description: Checkout created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckoutResponse'
        '400':
          description: Invalid request or offer not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Offer not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /checkouts/{checkout_id}:
    get:
      tags:
        - Checkouts
      summary: Get checkout details
      description: |
        Get detailed information about a checkout session including current status,
        items, pricing, frozen receipt (if approval requested), and audit trail.
      operationId: getCheckout
      parameters:
        - name: checkout_id
          in: path
          required: true
          schema:
            type: string
          description: Checkout identifier
      responses:
        '200':
          description: Checkout details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckoutResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Checkout not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /checkouts/{checkout_id}/quote:
    post:
      tags:
        - Checkouts
      summary: Get quote from merchant
      description: |
        Get a quote from the merchant for the checkout items. 
        
        This contacts the merchant to get current pricing and transitions the checkout
        to 'quoted' state. If called on an approved checkout with price changes,
        returns 409 with reapproval required.
      operationId: quoteCheckout
      parameters:
        - name: checkout_id
          in: path
          required: true
          schema:
            type: string
          description: Checkout identifier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckoutQuoteRequest'
            example:
              items:
                - product_id: "prod-001"
                  variant_id: "var-001"
                  quantity: 1
              customer_email: "customer@example.com"
      responses:
        '200':
          description: Quote received successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckoutResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Checkout not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Reapproval required due to price change
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReapprovalRequiredResponse'

  /checkouts/{checkout_id}/request-approval:
    post:
      tags:
        - Checkouts
      summary: Request approval
      description: |
        Request approval for the checkout and freeze the receipt. 
        
        This transitions the checkout to 'awaiting_approval' state and creates
        a frozen receipt snapshot for detecting price changes. The frozen receipt
        is used to detect if prices change between approval request and confirmation.
      operationId: requestApproval
      parameters:
        - name: checkout_id
          in: path
          required: true
          schema:
            type: string
          description: Checkout identifier
      responses:
        '200':
          description: Approval requested successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckoutResponse'
        '400':
          description: Invalid request or checkout not in valid state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Checkout not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /checkouts/{checkout_id}/approve:
    post:
      tags:
        - Checkouts
      summary: Approve checkout
      description: |
        Approve the checkout for purchase. 
        
        Transitions checkout to 'approved' state. If price has changed since
        approval was requested, returns 409 with REAPPROVAL_REQUIRED error.
      operationId: approveCheckout
      parameters:
        - name: checkout_id
          in: path
          required: true
          schema:
            type: string
          description: Checkout identifier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckoutApproveRequest'
            example:
              approved_by: "user"
      responses:
        '200':
          description: Checkout approved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckoutResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Checkout not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Reapproval required due to price change
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReapprovalRequiredResponse'

  /checkouts/{checkout_id}/confirm:
    post:
      tags:
        - Checkouts
      summary: Confirm checkout (execute purchase)
      description: |
        Execute the purchase with the merchant. 
        
        This calls the merchant to confirm the checkout and create an order.
        Requires checkout to be in 'approved' state. If price has changed,
        returns 409 with REAPPROVAL_REQUIRED error.
        
        After successful confirmation, an order is created and can be tracked
        via the Orders API.
      operationId: confirmCheckout
      parameters:
        - name: checkout_id
          in: path
          required: true
          schema:
            type: string
          description: Checkout identifier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckoutConfirmRequest'
            example:
              payment_method: "test_card"
              idempotency_key: "confirm-key-123"
      responses:
        '200':
          description: Purchase confirmed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckoutConfirmResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Checkout not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Reapproval required due to price change
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReapprovalRequiredResponse'

  /orders:
    get:
      tags:
        - Orders
      summary: List orders
      description: |
        Get a paginated list of orders with optional filtering by status or merchant.
      operationId: listOrders
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number (1-based)
        - name: page_size
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Items per page
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, confirmed, shipped, delivered, cancelled, refunded]
          description: Filter by order status
        - name: merchant_id
          in: query
          schema:
            type: string
          description: Filter by merchant ID
      responses:
        '200':
          description: List of orders
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrdersListResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /orders/{order_id}:
    get:
      tags:
        - Orders
      summary: Get order details
      description: |
        Get detailed information about a specific order including items, addresses,
        shipping info, status history, and tracking information.
      operationId: getOrder
      parameters:
        - name: order_id
          in: path
          required: true
          schema:
            type: string
          description: Order identifier
      responses:
        '200':
          description: Order details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /orders/{order_id}/cancel:
    post:
      tags:
        - Orders
      summary: Cancel order
      description: |
        Cancel an order. Only pending, confirmed, or shipped orders can be cancelled.
        Delivered orders cannot be cancelled.
      operationId: cancelOrder
      parameters:
        - name: order_id
          in: path
          required: true
          schema:
            type: string
          description: Order identifier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderCancelRequest'
            example:
              reason: "Changed mind"
              cancelled_by: "customer"
      responses:
        '200':
          description: Order cancelled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '400':
          description: Invalid request or order cannot be cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /orders/{order_id}/refund:
    post:
      tags:
        - Orders
      summary: Refund order
      description: |
        Refund a cancelled or delivered order. If no amount is specified,
        a full refund is issued.
      operationId: refundOrder
      parameters:
        - name: order_id
          in: path
          required: true
          schema:
            type: string
          description: Order identifier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderRefundRequest'
            example:
              refund_amount_cents: null
              reason: "Customer request"
      responses:
        '200':
          description: Order refunded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '400':
          description: Invalid request or order cannot be refunded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Bearer token authentication. Include the API key in the Authorization header:
        `Authorization: Bearer YOUR_API_KEY`

  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: "healthy"
        service:
          type: string
          example: "cartpilot-api"
        version:
          type: string
          example: "0.1.0"

    ErrorResponse:
      type: object
      required:
        - error_code
        - message
      properties:
        error_code:
          type: string
          description: Machine-readable error code
          example: "INTENT_NOT_FOUND"
        message:
          type: string
          description: Human-readable error message
          example: "Intent not found: intent-123"
        details:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              message:
                type: string
        request_id:
          type: string
          description: Request ID for correlation
          nullable: true

    Currency:
      type: string
      enum:
        - USD
        - EUR
        - GBP
      description: ISO 4217 currency code

    PriceSchema:
      type: object
      required:
        - amount
        - currency
      properties:
        amount:
          type: integer
          description: Amount in smallest currency unit (cents)
          example: 9999
        currency:
          $ref: '#/components/schemas/Currency'

    IntentCreateRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          minLength: 1
          maxLength: 500
          description: Natural language search query
          example: "wireless headphones under $100"
        session_id:
          type: string
          nullable: true
          description: Optional session identifier for the agent
          example: "chat-session-123"
        metadata:
          type: object
          additionalProperties: true
          description: Optional metadata (filters, hints)
          example:
            max_price: 10000
            category: "electronics"

    IntentResponse:
      type: object
      required:
        - id
        - query
        - created_at
        - updated_at
      properties:
        id:
          type: string
          description: Unique intent identifier
        query:
          type: string
          description: The original search query
        session_id:
          type: string
          nullable: true
        metadata:
          type: object
          additionalProperties: true
        offers_collected:
          type: boolean
          default: false
        offer_count:
          type: integer
          default: 0
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    OfferItemSchema:
      type: object
      required:
        - product_id
        - title
        - price
        - quantity_available
      properties:
        product_id:
          type: string
        variant_id:
          type: string
          nullable: true
        sku:
          type: string
          nullable: true
        title:
          type: string
        description:
          type: string
          nullable: true
        brand:
          type: string
          nullable: true
        category_path:
          type: string
          nullable: true
        price:
          $ref: '#/components/schemas/PriceSchema'
        quantity_available:
          type: integer
        image_url:
          type: string
          nullable: true
        rating:
          type: number
          format: float
          minimum: 0
          maximum: 5
          nullable: true
        review_count:
          type: integer
          nullable: true

    OfferResponse:
      type: object
      required:
        - id
        - intent_id
        - merchant_id
        - items
        - item_count
        - created_at
      properties:
        id:
          type: string
        intent_id:
          type: string
        merchant_id:
          type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/OfferItemSchema'
        item_count:
          type: integer
        lowest_price:
          $ref: '#/components/schemas/PriceSchema'
          nullable: true
        highest_price:
          $ref: '#/components/schemas/PriceSchema'
          nullable: true
        expires_at:
          type: string
          format: date-time
          nullable: true
        is_expired:
          type: boolean
          default: false
        metadata:
          type: object
          additionalProperties: true
        created_at:
          type: string
          format: date-time

    OffersListResponse:
      allOf:
        - type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/OfferResponse'
            intent_id:
              type: string
        - $ref: '#/components/schemas/PaginatedResponse'

    CheckoutCreateRequest:
      type: object
      required:
        - offer_id
        - items
      properties:
        offer_id:
          type: string
        items:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/CheckoutItemRequest'
        idempotency_key:
          type: string
          nullable: true

    CheckoutItemRequest:
      type: object
      required:
        - product_id
        - quantity
      properties:
        product_id:
          type: string
        variant_id:
          type: string
          nullable: true
        quantity:
          type: integer
          minimum: 1

    CheckoutQuoteRequest:
      type: object
      required:
        - items
      properties:
        items:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/CheckoutItemRequest'
        customer_email:
          type: string
          nullable: true

    CheckoutApproveRequest:
      type: object
      properties:
        approved_by:
          type: string
          default: "user"
          description: Identifier of who is approving

    CheckoutConfirmRequest:
      type: object
      properties:
        payment_method:
          type: string
          default: "test_card"
        idempotency_key:
          type: string
          nullable: true

    CheckoutStatusEnum:
      type: string
      enum:
        - created
        - quoted
        - awaiting_approval
        - approved
        - confirmed
        - failed
        - cancelled

    CheckoutItemSchema:
      type: object
      required:
        - product_id
        - sku
        - title
        - unit_price
        - quantity
        - line_total
      properties:
        product_id:
          type: string
        variant_id:
          type: string
          nullable: true
        sku:
          type: string
        title:
          type: string
        unit_price:
          $ref: '#/components/schemas/PriceSchema'
        quantity:
          type: integer
          minimum: 1
        line_total:
          $ref: '#/components/schemas/PriceSchema'

    FrozenReceiptItemSchema:
      type: object
      required:
        - product_id
        - sku
        - title
        - unit_price_cents
        - quantity
        - currency
      properties:
        product_id:
          type: string
        variant_id:
          type: string
          nullable: true
        sku:
          type: string
        title:
          type: string
        unit_price_cents:
          type: integer
        quantity:
          type: integer
        currency:
          type: string

    FrozenReceiptSchema:
      type: object
      required:
        - hash
        - items
        - subtotal_cents
        - tax_cents
        - shipping_cents
        - total_cents
        - currency
        - frozen_at
      properties:
        hash:
          type: string
          description: Receipt hash for change detection
        items:
          type: array
          items:
            $ref: '#/components/schemas/FrozenReceiptItemSchema'
        subtotal_cents:
          type: integer
        tax_cents:
          type: integer
        shipping_cents:
          type: integer
        total_cents:
          type: integer
        currency:
          type: string
        frozen_at:
          type: string
          format: date-time

    AuditEntrySchema:
      type: object
      required:
        - timestamp
        - action
        - to_status
      properties:
        timestamp:
          type: string
          format: date-time
        action:
          type: string
        from_status:
          type: string
          nullable: true
        to_status:
          type: string
          nullable: true
        actor:
          type: string
          nullable: true
        details:
          type: object
          additionalProperties: true
          nullable: true

    CheckoutResponse:
      type: object
      required:
        - id
        - offer_id
        - merchant_id
        - status
        - items
        - audit_trail
        - created_at
        - updated_at
      properties:
        id:
          type: string
        offer_id:
          type: string
        merchant_id:
          type: string
        status:
          $ref: '#/components/schemas/CheckoutStatusEnum'
        items:
          type: array
          items:
            $ref: '#/components/schemas/CheckoutItemSchema'
        subtotal:
          $ref: '#/components/schemas/PriceSchema'
          nullable: true
        tax:
          $ref: '#/components/schemas/PriceSchema'
          nullable: true
        shipping:
          $ref: '#/components/schemas/PriceSchema'
          nullable: true
        total:
          $ref: '#/components/schemas/PriceSchema'
          nullable: true
        merchant_checkout_id:
          type: string
          nullable: true
        receipt_hash:
          type: string
          nullable: true
        frozen_receipt:
          $ref: '#/components/schemas/FrozenReceiptSchema'
          nullable: true
        merchant_order_id:
          type: string
          nullable: true
        approved_by:
          type: string
          nullable: true
        approved_at:
          type: string
          format: date-time
          nullable: true
        confirmed_at:
          type: string
          format: date-time
          nullable: true
        expires_at:
          type: string
          format: date-time
          nullable: true
        failure_reason:
          type: string
          nullable: true
        audit_trail:
          type: array
          items:
            $ref: '#/components/schemas/AuditEntrySchema'

    CheckoutConfirmResponse:
      type: object
      required:
        - checkout_id
        - merchant_order_id
        - status
        - total
        - confirmed_at
      properties:
        checkout_id:
          type: string
        merchant_order_id:
          type: string
        order_id:
          type: string
          nullable: true
        status:
          $ref: '#/components/schemas/CheckoutStatusEnum'
        total:
          $ref: '#/components/schemas/PriceSchema'
        confirmed_at:
          type: string
          format: date-time

    ReapprovalRequiredResponse:
      type: object
      required:
        - error_code
        - message
        - checkout_id
        - original_total
        - new_total
      properties:
        error_code:
          type: string
          default: "REAPPROVAL_REQUIRED"
        message:
          type: string
        checkout_id:
          type: string
        original_total:
          $ref: '#/components/schemas/PriceSchema'
        new_total:
          $ref: '#/components/schemas/PriceSchema'
        price_difference:
          $ref: '#/components/schemas/PriceSchema'

    OrderStatusEnum:
      type: string
      enum:
        - pending
        - confirmed
        - shipped
        - delivered
        - returned
        - cancelled
        - refunded

    OrderAddressSchema:
      type: object
      required:
        - line1
        - city
        - postal_code
        - country
      properties:
        line1:
          type: string
        line2:
          type: string
          nullable: true
        city:
          type: string
        state:
          type: string
          nullable: true
        postal_code:
          type: string
        country:
          type: string
          description: ISO 3166-1 alpha-2 country code

    OrderCustomerSchema:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
        name:
          type: string
          nullable: true
        phone:
          type: string
          nullable: true

    OrderItemSchema:
      type: object
      required:
        - product_id
        - title
        - quantity
        - unit_price
        - line_total
      properties:
        product_id:
          type: string
        variant_id:
          type: string
          nullable: true
        sku:
          type: string
          nullable: true
        title:
          type: string
        quantity:
          type: integer
          minimum: 1
        unit_price:
          $ref: '#/components/schemas/PriceSchema'
        line_total:
          $ref: '#/components/schemas/PriceSchema'

    OrderStatusHistorySchema:
      type: object
      required:
        - to_status
        - created_at
      properties:
        from_status:
          type: string
          nullable: true
        to_status:
          type: string
        reason:
          type: string
          nullable: true
        actor:
          type: string
          nullable: true
        metadata:
          type: object
          additionalProperties: true
          nullable: true
        created_at:
          type: string

    OrderResponse:
      type: object
      required:
        - id
        - checkout_id
        - merchant_id
        - status
        - customer
        - shipping_address
        - items
        - subtotal
        - tax
        - shipping
        - total
        - status_history
        - created_at
        - updated_at
      properties:
        id:
          type: string
        checkout_id:
          type: string
        merchant_id:
          type: string
        merchant_order_id:
          type: string
          nullable: true
        status:
          $ref: '#/components/schemas/OrderStatusEnum'
        customer:
          $ref: '#/components/schemas/OrderCustomerSchema'
        shipping_address:
          $ref: '#/components/schemas/OrderAddressSchema'
        billing_address:
          $ref: '#/components/schemas/OrderAddressSchema'
          nullable: true
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItemSchema'
        subtotal:
          $ref: '#/components/schemas/PriceSchema'
        tax:
          $ref: '#/components/schemas/PriceSchema'
        shipping:
          $ref: '#/components/schemas/PriceSchema'
        total:
          $ref: '#/components/schemas/PriceSchema'
        tracking_number:
          type: string
          nullable: true
        carrier:
          type: string
          nullable: true
        cancelled_reason:
          type: string
          nullable: true
        cancelled_by:
          type: string
          nullable: true
        refund_amount:
          $ref: '#/components/schemas/PriceSchema'
          nullable: true
        refund_reason:
          type: string
          nullable: true
        status_history:
          type: array
          items:
            $ref: '#/components/schemas/OrderStatusHistorySchema'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        confirmed_at:
          type: string
          format: date-time
          nullable: true
        shipped_at:
          type: string
          format: date-time
          nullable: true
        delivered_at:
          type: string
          format: date-time
          nullable: true
        cancelled_at:
          type: string
          format: date-time
          nullable: true
        refunded_at:
          type: string
          format: date-time
          nullable: true

    OrderSummarySchema:
      type: object
      required:
        - id
        - merchant_id
        - status
        - total
        - item_count
        - customer_email
        - created_at
      properties:
        id:
          type: string
        merchant_id:
          type: string
        merchant_order_id:
          type: string
          nullable: true
        status:
          $ref: '#/components/schemas/OrderStatusEnum'
        total:
          $ref: '#/components/schemas/PriceSchema'
        item_count:
          type: integer
        customer_email:
          type: string
        created_at:
          type: string
          format: date-time

    OrdersListResponse:
      allOf:
        - type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/OrderSummarySchema'
        - $ref: '#/components/schemas/PaginatedResponse'

    OrderCancelRequest:
      type: object
      required:
        - reason
      properties:
        reason:
          type: string
        cancelled_by:
          type: string
          default: "customer"

    OrderRefundRequest:
      type: object
      properties:
        refund_amount_cents:
          type: integer
          nullable: true
          description: Refund amount in cents (null for full refund)
        reason:
          type: string
          default: ""

    PaginatedResponse:
      type: object
      required:
        - total
        - page
        - page_size
        - has_more
      properties:
        total:
          type: integer
        page:
          type: integer
          minimum: 1
        page_size:
          type: integer
          minimum: 1
          maximum: 100
        has_more:
          type: boolean
